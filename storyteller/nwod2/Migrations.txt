&MIGRATE`STATS [u(cobj,migrate)]=@dolist lsearch(all,type,player)=@wait #@={@trigger %!/TRG`STATS=%i0}

&TRG`STATS [u(cobj,migrate)]=th u(setstat`%va,%0,D`INFO,CLASS,u(getstat`%va,%0,D`INFO,Sphere));@select/inline getclass(%0)=Geist,{th u(setstat`%va,%0,D`INFO,SIN-EATER)};&D`POOLS`WILLPOWER`CUR %0=u(getstat`%va,%0,D`POOLS,Willpower);&D`POOLS`[switch(getclass(%0),VAMPIRE,HUMANITY,WEREWOLF,HARMONY,CHANGELING,CLARITY,BEAST,SATIETY,INTEGRITY)]`CUR %0=switch(getclass(%0),BEAST,u(getstat`%va,%0,D`POOLS,Power),u(getstat`%va,%0,D`INFO,Morality));&D`POOLS`[switch(getclass(%0),VAMPIRE,VITAE,WEREWOLF,ESSENCE,CHANGELING,GLAMOUR,BEAST,SATIETY)]`CUR %0=u(getstat`%va,%0,D`POOLS,Power);@dolist/inline D`RITE~D`RITES D`SGIFT~D`SGIFTS D`ATAVISM~D`ATAVISMS D`NIGHTMARE~D`NIGHTMARES D`LTRAIT~D`LAIRTRAITS={@mvattr %0/[before(%i0,~)]=%0/[after(%i0,~)]};@dolist/inline filterbool(#lambda/hasattrval(%0/\%0),D`ATTRIBUTES D`SKILLS D`SPECIALTIES D`BONUS D`DISCIPLINES D`RENOWN D`GIFTS D`SGIFTS D`RITES D`ARCANA D`CONTRACTS D`ENDOWMENTS D`MANIFESTATIONS D`CEREMONIES)={&%i0 %0=ucstr(edit(get(%0/%i0),_,%b))};@dolist/inline filterbool(#lambda/hasattrval(%0/\%0),D`KEYS D`ECHOES D`TRANSMUTATIONS D`BESTOWMENTS D`EMBEDS D`EXPLOITS D`ATAVISMS D`NIGHTMARES D`LAIRTRAITS)={&%i0 %0=iter(ucstr(get(%0/%i0)),if(isint(last(%i0)),elements(%i0,lnum(1,sub(words(%i0),1)))~[last(%i0)],%i0~1),|,|)}

&MIGRATE`MERITS [u(cobj,migrate)]=@dolist lsearch(all,type,player)=@wait #@={@dolist/inline D`MERITS D`FLAWS ={@dolist/inline/delimit | [get(%i1/%i0)]={th u(setq`%va,merit,ucstr(trim(before(before(before(%i0,\(),:),~))));th u(setq`%va,context,strfirstof(trim(after(before(%i0,~),:)),before(after(before(%i0,~),\(),\))));th u(setq`%va,rank,after(%i0,~));@attach [u(cobj,merit)]/DO`ADD=%i1`[inum(0)],%i2,%q<merit>,%q<context>,%q<rank>;@attach [u(cobj,merit)]/DO`UPD=%i1`[inum(0)],%i2}}}

&MIGRATE`XP [u(cobj,migrate)]=@dolist lsearch(all,type,player)=@wait #@={@dolist/inline sortkey(#lambda/get(%i0/\%0`ON),u(lattr`%va,%i0/D`XP`*`*))=th u(u(cobj,xp)/MYSQL,INSERT`XP2,u(objid,%i1),XP,switch(elements(%i0,3,`),G,get(%i1/%i0),S,mul(-1,get(%i1/%i0))),get(%i1/%i0`REASON),get(%i1/%i0`BY),get(%i1/%i0`ON))}
